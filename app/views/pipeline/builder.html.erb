<div class="builder-container" data-controller="pipeline simulation validation" data-pipeline-template-value="<%= @template || '' %>" data-pipeline-load-config-value="<%= @load_config || '' %>">
  <!-- Pipeline Type Tabs -->
  <div class="pipeline-tabs">
    <button class="pipeline-tab active" data-action="click->pipeline#switchTab" data-pipeline-type-param="traces">
      ‚ñ∏ Traces <span class="tab-count" data-pipeline-target="tracesCount">0</span>
    </button>
    <button class="pipeline-tab" data-action="click->pipeline#switchTab" data-pipeline-type-param="metrics">
      ‚ñ∏ Metrics <span class="tab-count" data-pipeline-target="metricsCount">0</span>
    </button>
    <button class="pipeline-tab" data-action="click->pipeline#switchTab" data-pipeline-type-param="logs">
      ‚ñ∏ Logs <span class="tab-count" data-pipeline-target="logsCount">0</span>
    </button>
    <div style="flex:1"></div>
    <button class="btn btn-purple btn-sm" style="margin:0.3rem 0" data-action="click->pipeline#openImportModal">üì• Import</button>
    <button class="btn btn-amber btn-sm" style="margin:0.3rem 0" data-sim-btn data-action="click->simulation#start">‚ñ∂ Simulate</button>
    <button class="btn btn-cyan btn-sm" style="margin:0.3rem 0" data-action="click->pipeline#openSaveModal">
      ‚¨Ü Save Config
    </button>
    <button class="btn btn-green btn-sm" style="margin:0.3rem 0" data-action="click->pipeline#openCommunityModal">
      üåê Save to Community
    </button>
  </div>

  <!-- Component Palette -->
  <div class="component-palette">
    <div class="palette-section">
      <div class="palette-section-title">‚¨§ Receivers</div>
      <div class="palette-item" draggable="true" data-category="receivers" data-component="otlp"
           data-action="dragstart->pipeline#dragStart click->pipeline#addComponent">
        <span class="dot"></span> otlp
      </div>
      <div class="palette-item" draggable="true" data-category="receivers" data-component="prometheus"
           data-action="dragstart->pipeline#dragStart click->pipeline#addComponent">
        <span class="dot"></span> prometheus
      </div>
      <div class="palette-item" draggable="true" data-category="receivers" data-component="hostmetrics"
           data-action="dragstart->pipeline#dragStart click->pipeline#addComponent">
        <span class="dot"></span> hostmetrics
      </div>
      <div class="palette-item" draggable="true" data-category="receivers" data-component="filelog"
           data-action="dragstart->pipeline#dragStart click->pipeline#addComponent">
        <span class="dot"></span> filelog
      </div>
      <div class="palette-item" draggable="true" data-category="receivers" data-component="journald"
           data-action="dragstart->pipeline#dragStart click->pipeline#addComponent">
        <span class="dot"></span> journald
      </div>
      <div class="palette-item" draggable="true" data-category="receivers" data-component="k8s_events"
           data-action="dragstart->pipeline#dragStart click->pipeline#addComponent">
        <span class="dot"></span> k8s_events
      </div>
      <div class="palette-item" draggable="true" data-category="receivers" data-component="zipkin"
           data-action="dragstart->pipeline#dragStart click->pipeline#addComponent">
        <span class="dot"></span> zipkin
      </div>
      <div class="palette-item" draggable="true" data-category="receivers" data-component="jaeger"
           data-action="dragstart->pipeline#dragStart click->pipeline#addComponent">
        <span class="dot"></span> jaeger
      </div>
    </div>

    <div class="palette-section">
      <div class="palette-section-title">‚¨§ Processors</div>
      <div class="palette-item" draggable="true" data-category="processors" data-component="batch"
           data-action="dragstart->pipeline#dragStart click->pipeline#addComponent">
        <span class="dot"></span> batch
      </div>
      <div class="palette-item" draggable="true" data-category="processors" data-component="memory_limiter"
           data-action="dragstart->pipeline#dragStart click->pipeline#addComponent">
        <span class="dot"></span> memory_limiter
      </div>
      <div class="palette-item" draggable="true" data-category="processors" data-component="attributes"
           data-action="dragstart->pipeline#dragStart click->pipeline#addComponent">
        <span class="dot"></span> attributes
      </div>
      <div class="palette-item" draggable="true" data-category="processors" data-component="filter"
           data-action="dragstart->pipeline#dragStart click->pipeline#addComponent">
        <span class="dot"></span> filter
      </div>
      <div class="palette-item" draggable="true" data-category="processors" data-component="transform"
           data-action="dragstart->pipeline#dragStart click->pipeline#addComponent">
        <span class="dot"></span> transform
      </div>
      <div class="palette-item" draggable="true" data-category="processors" data-component="resource"
           data-action="dragstart->pipeline#dragStart click->pipeline#addComponent">
        <span class="dot"></span> resource
      </div>
      <div class="palette-item" draggable="true" data-category="processors" data-component="probabilistic_sampler"
           data-action="dragstart->pipeline#dragStart click->pipeline#addComponent">
        <span class="dot"></span> probabilistic_sampler
      </div>
      <div class="palette-item" draggable="true" data-category="processors" data-component="tail_sampling"
           data-action="dragstart->pipeline#dragStart click->pipeline#addComponent">
        <span class="dot"></span> tail_sampling
      </div>
      <div class="palette-item" draggable="true" data-category="processors" data-component="k8s_attributes"
           data-action="dragstart->pipeline#dragStart click->pipeline#addComponent">
        <span class="dot"></span> k8s_attributes
      </div>
      <div class="palette-item" draggable="true" data-category="processors" data-component="resourcedetection"
           data-action="dragstart->pipeline#dragStart click->pipeline#addComponent">
        <span class="dot"></span> resourcedetection
      </div>
    </div>

    <div class="palette-section">
      <div class="palette-section-title">‚¨§ Exporters</div>
      <div class="palette-item" draggable="true" data-category="exporters" data-component="otlp"
           data-action="dragstart->pipeline#dragStart click->pipeline#addComponent">
        <span class="dot"></span> otlp
      </div>
      <div class="palette-item" draggable="true" data-category="exporters" data-component="otlphttp"
           data-action="dragstart->pipeline#dragStart click->pipeline#addComponent">
        <span class="dot"></span> otlphttp
      </div>
      <div class="palette-item" draggable="true" data-category="exporters" data-component="prometheus"
           data-action="dragstart->pipeline#dragStart click->pipeline#addComponent">
        <span class="dot"></span> prometheus
      </div>
      <div class="palette-item" draggable="true" data-category="exporters" data-component="debug"
           data-action="dragstart->pipeline#dragStart click->pipeline#addComponent">
        <span class="dot"></span> debug
      </div>
      <div class="palette-item" draggable="true" data-category="exporters" data-component="file"
           data-action="dragstart->pipeline#dragStart click->pipeline#addComponent">
        <span class="dot"></span> file
      </div>
      <div class="palette-item" draggable="true" data-category="exporters" data-component="elasticsearch"
           data-action="dragstart->pipeline#dragStart click->pipeline#addComponent">
        <span class="dot"></span> elasticsearch
      </div>
      <div class="palette-item" draggable="true" data-category="exporters" data-component="loki"
           data-action="dragstart->pipeline#dragStart click->pipeline#addComponent">
        <span class="dot"></span> loki
      </div>
    </div>

    <div class="palette-section">
      <div class="palette-section-title" style="color:var(--purple)">‚¨° Connectors</div>
      <div class="palette-item" draggable="true" data-category="connectors" data-component="spanmetrics"
           data-action="dragstart->pipeline#dragStart click->pipeline#addComponent">
        <span class="dot"></span> spanmetrics
        <span style="font-size:0.55rem;color:var(--purple);opacity:0.7;margin-left:auto">traces‚Üímetrics</span>
      </div>
      <div class="palette-item" draggable="true" data-category="connectors" data-component="count"
           data-action="dragstart->pipeline#dragStart click->pipeline#addComponent">
        <span class="dot"></span> count
        <span style="font-size:0.55rem;color:var(--purple);opacity:0.7;margin-left:auto">any‚Üímetrics</span>
      </div>
    </div>
  </div>

  <!-- Pipeline Canvas -->
  <div class="pipeline-canvas">
    <div class="pipeline-flow">
      <div class="pipeline-column" data-type="receivers">
        <div class="pipeline-column-header">Receivers</div>
        <div class="pipeline-components"
             data-pipeline-target="receiversDrop"
             data-action="dragover->pipeline#dragOver dragleave->pipeline#dragLeave drop->pipeline#drop"
             data-drop-category="receivers">
        </div>
      </div>
      <div class="pipeline-arrow">‚Üí</div>
      <div class="pipeline-column" data-type="processors">
        <div class="pipeline-column-header">Processors</div>
        <div class="pipeline-components"
             data-pipeline-target="processorsDrop"
             data-action="dragover->pipeline#dragOver dragleave->pipeline#dragLeave drop->pipeline#drop"
             data-drop-category="processors">
        </div>
      </div>
      <div class="pipeline-arrow">‚Üí</div>
      <div class="pipeline-column" data-type="exporters">
        <div class="pipeline-column-header">Exporters</div>
        <div class="pipeline-components"
             data-pipeline-target="exportersDrop"
             data-action="dragover->pipeline#dragOver dragleave->pipeline#dragLeave drop->pipeline#drop"
             data-drop-category="exporters">
        </div>
      </div>
    </div>

    <!-- Validation Panel -->
    <div class="validation-panel" style="display:none" data-validation-target="panel">
      <div class="validation-header" data-action="click->validation#toggle">
        <span>‚ö† Validation Warnings <span data-validation-target="count" style="background:var(--amber-dim);color:var(--bg);padding:0.1rem 0.4rem;border-radius:3px;font-size:0.65rem;font-weight:700;margin-left:0.3rem">0</span></span>
        <span data-validation-target="chevron">‚ñæ</span>
      </div>
      <div class="validation-body" data-validation-target="body"></div>
    </div>

    <!-- Simulation Overlay -->
    <div class="sim-overlay" data-simulation-target="overlay">
      <div class="sim-toolbar">
        <div style="color:var(--text)">‚ñ∂ Pipeline Simulation ‚Äî <span class="sim-type-label">traces</span></div>
        <div class="sim-progress"><div class="sim-progress-fill"></div></div>
        <button class="btn btn-sm" data-action="click->simulation#closeOverlay">‚úï Close</button>
      </div>
      <div class="sim-body">
        <div class="sim-canvas" data-simulation-target="simCanvas"></div>
        <div class="sim-log-panel">
          <div class="sim-log-header">üì° Event Log</div>
          <div class="sim-log-entries" data-simulation-target="logEntries"></div>
        </div>
      </div>
      <div class="sim-summary" data-simulation-target="summaryPanel">
        <div class="sim-summary-header">
          <h3>‚úì Simulation Complete</h3>
          <button class="btn btn-sm" data-action="click->simulation#closeOverlay">‚úï Close</button>
        </div>
        <div data-simulation-target="summaryContent"></div>
      </div>
    </div>
  </div>

  <!-- Right Sidebar: Config + YAML -->
  <div class="config-sidebar">
    <div class="config-panel-tabs" style="flex-wrap:wrap">
      <button class="config-panel-tab active" data-action="click->pipeline#switchConfigTab" data-tab="config">Component</button>
      <button class="config-panel-tab" data-action="click->pipeline#switchConfigTab" data-tab="yaml">YAML Output</button>
      <button class="config-panel-tab" data-action="click->pipeline#switchConfigTab" data-tab="deploy">üì¶ Deploy</button>
      <button class="config-panel-tab" data-action="click->pipeline#switchConfigTab" data-tab="instrument">üöÄ Instrument</button>
    </div>

    <!-- Component Config Tab -->
    <div class="config-panel-content" data-pipeline-target="configPanel">
      <div class="config-form">
        <div class="no-selection" data-pipeline-target="noSelection">
          Click a component in the pipeline to configure it
        </div>
        <div data-pipeline-target="configFields" style="display:none">
        </div>
      </div>
    </div>

    <!-- YAML Output Tab -->
    <div class="config-panel-content hidden" data-pipeline-target="yamlPanel">
      <div class="yaml-panel">
        <div class="yaml-actions">
          <button class="btn btn-green btn-sm" data-action="click->pipeline#copyYaml">üìã Copy</button>
          <button class="btn btn-sm" data-action="click->pipeline#clearPipeline">‚úï Clear</button>
        </div>
        <div class="yaml-output" data-pipeline-target="yamlOutput">
# Add components to your pipeline to generate config
        </div>
      </div>
    </div>

    <!-- Deploy Tab -->
    <div class="config-panel-content hidden" data-pipeline-target="deployPanel" data-controller="deploy">
      <div class="deploy-panel">
        <div class="deploy-subtabs">
          <button class="deploy-subtab active" data-deploy-target="subtab" data-format="docker-compose" data-action="click->deploy#switchFormat">Docker Compose</button>
          <button class="deploy-subtab" data-deploy-target="subtab" data-format="k8s-daemonset" data-action="click->deploy#switchFormat">K8s DaemonSet</button>
          <button class="deploy-subtab" data-deploy-target="subtab" data-format="k8s-deployment" data-action="click->deploy#switchFormat">K8s Deployment</button>
          <button class="deploy-subtab" data-deploy-target="subtab" data-format="helm-values" data-action="click->deploy#switchFormat">Helm Values</button>
        </div>
        <div class="yaml-actions">
          <button class="btn btn-green btn-sm" data-action="click->deploy#copy">üìã Copy</button>
        </div>
        <div class="yaml-output" data-deploy-target="output"># Add components to your pipeline first</div>
      </div>
    </div>

    <!-- Instrument Tab -->
    <div class="config-panel-content hidden" data-pipeline-target="instrumentPanel" data-controller="instrument">
      <div class="instrument-panel">
        <div class="deploy-subtabs">
          <button class="deploy-subtab active" data-instrument-target="langtab" data-lang="python" data-action="click->instrument#switchLang">Python</button>
          <button class="deploy-subtab" data-instrument-target="langtab" data-lang="nodejs" data-action="click->instrument#switchLang">Node.js</button>
          <button class="deploy-subtab" data-instrument-target="langtab" data-lang="go" data-action="click->instrument#switchLang">Go</button>
          <button class="deploy-subtab" data-instrument-target="langtab" data-lang="java" data-action="click->instrument#switchLang">Java</button>
        </div>
        <div class="yaml-actions">
          <button class="btn btn-green btn-sm" data-action="click->instrument#copy">üìã Copy</button>
        </div>
        <div class="install-cmd" data-instrument-target="installCmd"></div>
        <div class="yaml-output" data-instrument-target="output"># Add receivers to your pipeline first</div>
      </div>
    </div>

  </div>

  <!-- Data Preview Panel (INSIDE controller scope) -->
  <div class="data-preview-panel" data-simulation-target="previewPanel">
    <div class="data-preview-header">
      <h3 data-simulation-target="previewTitle">Component Data Preview</h3>
      <button class="btn btn-sm" data-action="click->simulation#closePreview">‚úï Close</button>
    </div>
    <div class="data-preview-body">
      <div class="data-preview-col">
        <h4>‚ñ∏ Before (Input)</h4>
        <pre data-simulation-target="previewBefore"></pre>
      </div>
      <div class="data-preview-col">
        <h4>‚ñ∏ After (Output)</h4>
        <pre data-simulation-target="previewAfter"></pre>
      </div>
    </div>
  </div>

  <!-- Save Config Modal (INSIDE controller scope) -->
  <div class="modal-overlay" data-pipeline-target="saveModal">
    <div class="modal">
      <h3>‚¨Ü Save Configuration</h3>
      <p style="color:var(--text-dim);font-size:0.8rem;margin-bottom:0.75rem">Save your config and get a shareable link.</p>
      <div class="config-field">
        <label>Name</label>
        <input type="text" data-pipeline-target="saveName" placeholder="My OTel Config">
      </div>
      <div class="config-field">
        <label>Description</label>
        <textarea data-pipeline-target="saveDescription" placeholder="What this config does..."></textarea>
      </div>
      <div class="config-field">
        <label>Tags</label>
        <div class="save-tags" data-pipeline-target="saveTags">
          <label class="save-tag-label" onclick="this.classList.toggle('checked')"><input type="checkbox" value="kubernetes"> kubernetes</label>
          <label class="save-tag-label" onclick="this.classList.toggle('checked')"><input type="checkbox" value="docker"> docker</label>
          <label class="save-tag-label" onclick="this.classList.toggle('checked')"><input type="checkbox" value="logs"> logs</label>
          <label class="save-tag-label" onclick="this.classList.toggle('checked')"><input type="checkbox" value="traces"> traces</label>
          <label class="save-tag-label" onclick="this.classList.toggle('checked')"><input type="checkbox" value="metrics"> metrics</label>
          <label class="save-tag-label" onclick="this.classList.toggle('checked')"><input type="checkbox" value="production"> production</label>
          <label class="save-tag-label" onclick="this.classList.toggle('checked')"><input type="checkbox" value="development"> development</label>
          <label class="save-tag-label" onclick="this.classList.toggle('checked')"><input type="checkbox" value="monitoring"> monitoring</label>
          <label class="save-tag-label" onclick="this.classList.toggle('checked')"><input type="checkbox" value="alerting"> alerting</label>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn" data-action="click->pipeline#closeSaveModal">Cancel</button>
        <button class="btn btn-cyan" data-action="click->pipeline#saveConfig">‚¨Ü Save & Get Link</button>
      </div>
    </div>
  </div>

  <!-- Import Modal (INSIDE controller scope) -->
  <div class="modal-overlay" data-pipeline-target="importModal">
    <div class="modal" style="max-width:600px">
      <h3 style="color:var(--purple)">üì• Import OTel Collector Config</h3>
      <p style="color:var(--text-dim);font-size:0.8rem;margin-bottom:0.75rem">Paste an existing OpenTelemetry Collector YAML config or upload a file to populate the visual builder.</p>
      <div class="config-field">
        <label>Upload File</label>
        <input type="file" accept=".yaml,.yml" data-pipeline-target="importFile" data-action="change->pipeline#handleImportFile"
               style="font-size:0.8rem;color:var(--text-dim);background:var(--bg);border:1px solid var(--border);padding:0.4rem;border-radius:4px;width:100%">
      </div>
      <div class="config-field">
        <label>Or Paste YAML</label>
        <textarea data-pipeline-target="importYaml" placeholder="receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
processors:
  batch:
    timeout: 200ms
exporters:
  debug:
    verbosity: basic
service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [batch]
      exporters: [debug]" style="height:220px;font-family:'Source Code Pro',monospace;font-size:0.75rem;resize:vertical"></textarea>
      </div>
      <div data-pipeline-target="importError" style="color:var(--red);font-size:0.8rem;min-height:1.2rem;margin-bottom:0.5rem"></div>
      <div class="modal-actions">
        <button class="btn" data-action="click->pipeline#closeImportModal">Cancel</button>
        <button class="btn btn-purple" data-action="click->pipeline#importConfig">Parse & Load</button>
      </div>
    </div>
  </div>

  <!-- Save to Community Modal (INSIDE controller scope) -->
  <div class="modal-overlay" data-pipeline-target="communityModal">
    <div class="modal" style="max-width:550px">
      <h3 style="color:var(--green)">üåê Save to Community Gallery</h3>
      <p style="color:var(--text-dim);font-size:0.8rem;margin-bottom:0.75rem">Share your pipeline config with the community. It will appear in the <a href="/configs" style="color:var(--cyan)">Community Gallery</a>.</p>
      <div class="config-field">
        <label>Name <span style="color:var(--red)">*</span></label>
        <input type="text" data-pipeline-target="communityName" placeholder="e.g. Production K8s Monitoring Stack">
      </div>
      <div class="config-field">
        <label>Description</label>
        <textarea data-pipeline-target="communityDescription" placeholder="Describe what this config does, what it's good for..." style="height:80px;resize:vertical"></textarea>
      </div>
      <div class="config-field">
        <label>Tags</label>
        <div class="save-tags" data-pipeline-target="communityTags">
          <label class="save-tag-label" onclick="this.classList.toggle('checked')"><input type="checkbox" value="kubernetes"> kubernetes</label>
          <label class="save-tag-label" onclick="this.classList.toggle('checked')"><input type="checkbox" value="docker"> docker</label>
          <label class="save-tag-label" onclick="this.classList.toggle('checked')"><input type="checkbox" value="logs"> logs</label>
          <label class="save-tag-label" onclick="this.classList.toggle('checked')"><input type="checkbox" value="traces"> traces</label>
          <label class="save-tag-label" onclick="this.classList.toggle('checked')"><input type="checkbox" value="metrics"> metrics</label>
          <label class="save-tag-label" onclick="this.classList.toggle('checked')"><input type="checkbox" value="production"> production</label>
          <label class="save-tag-label" onclick="this.classList.toggle('checked')"><input type="checkbox" value="development"> development</label>
          <label class="save-tag-label" onclick="this.classList.toggle('checked')"><input type="checkbox" value="monitoring"> monitoring</label>
          <label class="save-tag-label" onclick="this.classList.toggle('checked')"><input type="checkbox" value="alerting"> alerting</label>
        </div>
      </div>
      <div class="config-field">
        <label>Preview</label>
        <div class="yaml-output" data-pipeline-target="communityPreview" style="max-height:150px;overflow-y:auto;font-size:0.7rem">
# Build a pipeline first...
        </div>
      </div>
      <div data-pipeline-target="communityError" style="color:var(--red);font-size:0.8rem;min-height:1.2rem;margin-bottom:0.5rem"></div>
      <div class="modal-actions">
        <button class="btn" data-action="click->pipeline#closeCommunityModal">Cancel</button>
        <button class="btn btn-green" data-action="click->pipeline#saveToCommunity">üåê Publish to Gallery</button>
      </div>
    </div>
  </div>

</div>
