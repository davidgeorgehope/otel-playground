<div class="config-show">
  <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1rem;flex-wrap:wrap;gap:0.5rem">
    <div>
      <h1><%= @config.name %></h1>
      <% if @config.description.present? %>
        <p class="description"><%= @config.description %></p>
      <% end %>
      <% if @config.parsed_tags.any? %>
        <div class="show-tags" style="margin-top:0.5rem">
          <% @config.parsed_tags.each do |tag| %>
            <a href="<%= configs_path(tag: tag) %>" class="card-tag">#<%= tag %></a>
          <% end %>
        </div>
      <% end %>
    </div>
    <div style="display:flex;gap:0.5rem;flex-wrap:wrap">
      <a href="/?load=<%= @config.share_token %>" class="btn btn-green btn-sm">ğŸ”§ Load in Builder</a>
      <button class="btn btn-green btn-sm" onclick="copyConfigYaml()">ğŸ“‹ Copy YAML</button>
      <button class="upvote-btn show-upvote <%= 'upvoted' if cookies["upvoted_#{@config.id}"].present? %>"
              onclick="upvoteConfig('<%= @config.share_token %>', this)"
              <%= 'disabled' if cookies["upvoted_#{@config.id}"].present? %>>
        â–² <span class="upvote-count"><%= @config.upvotes %></span>
      </button>
      <a href="/configs" class="btn btn-sm">â† Back</a>
    </div>
  </div>

  <div class="yaml-block" id="config-yaml"><%= @config.yaml_output %></div>

  <div class="meta">
    <span>â–² <%= @config.upvotes %> upvotes</span>
    <span>ğŸ‘ <%= @config.views_count %> views</span>
    <span>Created <%= time_ago_in_words(@config.created_at) %> ago</span>
    <span>Share: <code style="color:var(--green)">/configs/<%= @config.share_token %></code></span>
  </div>

  <div style="margin-top:2rem">
    <% pipeline_data = @config.parsed_pipeline_data %>
    <% if pipeline_data["pipelines"] %>
      <h3 style="color:var(--amber);font-size:0.9rem;margin-bottom:0.75rem">Pipeline Components</h3>
      <% pipeline_data["pipelines"].each do |pipeline_type, pipeline| %>
        <div style="margin-bottom:0.75rem">
          <span style="color:var(--text-dim);font-size:0.8rem;text-transform:uppercase"><%= pipeline_type %></span>
          <div class="template-components" style="margin-top:0.3rem">
            <% (pipeline["receivers"] || []).each do |comp| %>
              <span class="template-tag receiver"><%= comp["type"] || comp["id"] %></span>
            <% end %>
            <% (pipeline["processors"] || []).each do |comp| %>
              <span class="template-tag processor"><%= comp["type"] || comp["id"] %></span>
            <% end %>
            <% (pipeline["exporters"] || []).each do |comp| %>
              <span class="template-tag exporter"><%= comp["type"] || comp["id"] %></span>
            <% end %>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>
</div>

<script>
function copyConfigYaml() {
  const yaml = document.getElementById("config-yaml").textContent;
  navigator.clipboard.writeText(yaml).then(() => {
    const feedback = document.createElement("div");
    feedback.className = "copy-feedback";
    feedback.textContent = "âœ“ Copied to clipboard";
    document.body.appendChild(feedback);
    setTimeout(() => feedback.remove(), 2000);
  });
}
function upvoteConfig(shareToken, btn) {
  if (btn.disabled) return;
  const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
  fetch(`/configs/${shareToken}/upvote`, {
    method: 'POST',
    headers: { 'Accept': 'application/json', 'X-CSRF-Token': csrfToken }
  }).then(r => r.json()).then(data => {
    btn.querySelector('.upvote-count').textContent = data.upvotes;
    btn.classList.add('upvoted');
    btn.disabled = true;
  }).catch(() => {});
}
</script>
